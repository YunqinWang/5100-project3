<!DOCTYPE html>
<html>
    <head lang="en">
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://d3js.org/topojson.v3.min.js"></script>

        <title>Info5100 Project3</title>
    </head>
    <style>
        body{
            width:90%;
            margin:auto;
        }
        .sector-axis .domain{
            stroke: none;
        }
    </style>
    <body>
        <h1>Project3</h1>
        <h6>Team member:Yunqin Wang(yw652), Ying Zhang(yz2249), Yu Yang(yy462), Jiaxin Li(jl3579), Peter Huang (mh2289)</h6>
        <h4>Job Gains and Losses of each Sector</h4>
        <svg id="sectorGrid" width="1700" height="400"></svg>
        <script>
            const sectorGrid = d3.select("#sectorGrid");
            const sectorGridWidth = sectorGrid.attr("width");
            const sectorGridHeight = sectorGrid.attr("height");
            const sectorGridMargin = {top: 50, right: 10, bottom: 10, left: 50};
            const sectorChartWidth = sectorGridWidth - sectorGridMargin.left - sectorGridMargin.right;
            const sectorChartHeight = sectorGridHeight - sectorGridMargin.top - sectorGridMargin.bottom;
            const sectorAxisOffset = 10;

            const sectorGridAnnotations = sectorGrid.append("g").attr("id","sectorGridAnnotations")
            let sectorChartArea = sectorGrid.append("g").attr("id","sectorChart")
                                            .attr("transform",`translate(${sectorGridMargin.left},${sectorGridMargin.top})`);


            const getSectorData = async ()=>{
                const sectorData = await d3.csv("./sector_employment_data.csv");

                let sectorChangeData = [];
                for(let i=1; i<sectorData.length; i++){

                    let d = sectorData[i];
                    let dashPos = d["Month"].indexOf("-");
                    let year = Number(d["Month"].slice(0, dashPos))+2000;
                    let monthName = d["Month"].slice(dashPos+1);
                    let date = new Date(Date.parse(monthName  +" 1, "+year ));

                    let dPrev = sectorData[i-1]
                    let sectorChange = []
                    
                    for(let[key,value] of Object.entries(d)){
                        
                        if(key.includes("Total")) continue;
                        if(key != "Month"){
                            value = (Number(d[key].replace(",",""))-Number(dPrev[key].replace(",","")))
                                    /Number(d[key].replace(",",""));
                            sectorChange.push({
                                "name" :key, 
                                "change": value.toFixed(4)*100,
                                "value":Number(d[key].replace(",",""))
                            });  
                        }
                    }

                    //sort the change rate
                    sectorChange.sort(function(a,b){
                        return a.change -b.change ;
                    })
                    
                    //find the item closest to zero
                    let firstAboveZero=-1;
                    sectorChange.forEach((item,index)=>{
                        if(firstAboveZero== -1 && item.change>=0){
                            firstAboveZero = index;
                        }
                        
                    })
                    sectorChange.forEach((d,i)=>{
                        sectorChangeData.push({
                            "date":date,
                            "sector": d.name, 
                            "change":d.change, 
                            "rank":i-firstAboveZero,
                            "value":d.value
                        })
                    })
                }

                console.log(sectorChangeData)
                const yearExtent = d3.extent(sectorChangeData, d=>d.date)
                const yearScale = d3.scaleTime().domain(yearExtent).range([0,sectorChartWidth]);
                
                const topYearAxis = d3.axisTop(yearScale)
                sectorGridAnnotations.append("g")
                                    .attr("class", "year sector-axis")
                                    .attr("transform",`translate(${sectorGridMargin.left-sectorAxisOffset},${sectorGridMargin.top})`)
                                    .call(topYearAxis)

                const rankExtent = [-20,20]
                const rankScale = d3.scaleLinear().domain(rankExtent).range([sectorChartHeight,0]);
                const leftChangeAxis = d3.axisLeft(rankScale)
                sectorGridAnnotations.append("g")
                                    .attr("class", "rank sector-axis")
                                    .attr("transform",`translate(${sectorGridMargin.left-sectorAxisOffset},${sectorGridMargin.top})`)
                                    .call(leftChangeAxis)

                let allChange = [];
                sectorChangeData.forEach(d=>{
                    allChange.push(d["change"])  
                })
                
                const changeExtent = d3.extent(sectorChangeData, d=>d.change)
                console.log(changeExtent);                    
                const sectorColorScale = d3.scaleQuantile()
                                            .domain(allChange)
                                            .range(["#5c74eb","#49c2ff",
                                            "#e3da3d","#ffaf4d","#ff6f56","#df3b82"])
         

                sectorChartArea.selectAll("rect.changeSquare").data(sectorChangeData)
                            .join("rect")
                            .attr('class',`changeSquare`)
                            .attr("fill", d=>sectorColorScale(d["change"]))
                            .attr("x", d => yearScale(d["date"]))
                            .attr("y", d => rankScale(d["rank"]))
                            .attr("width", 6)
                            .attr("height", 6)   
                            .attr("transform","translate(-6,-6)")     

            }
            getSectorData();

        </script>
    </body>
</html>

<style>

    body{
        color:#5c74eb
        #49c2ff
        #e3da3d
        #ffaf4d
        #ff6f56
        #df3b82
    }
</style>